<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="" />
    <style>
      .sender {
        color: #048ac7;
      }
      #alert {
        position: relative;
        opacity: 100%;
        transition: opacity 1s ease-in-out;
        text-align: center;
        margin: auto;
      }
      img {
        position: absolute;
      }
      .message {
        padding-top: 150px;
        font-size: 13px;
      }
      * {
        position: relative;
        font-family: Arial, Helvetica, sans-serif;
      }
      .bab {
        z-index: 1;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -25%);
      }
      #exp0 {
        z-index: 2;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -25%);
      }
      #exp1 {
        z-index: 3;
        top: 50%;
        left: 50%;
        transform: translate(-100%, -25%);
      }
      #exp2 {
        z-index: 3;
        top: 50%;
        left: 50%;
        transform: translate(0%, -25%);
      }

      .text {
        top: 150px;
      }
      .message {
        top: 150px;
      }
    </style>
  </head>
  <body>
    <div id="container" />

    <div id="alert"></div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="/tts.js"></script>

    <script>
      const alertQueue = [];
      const alertElement = document.getElementById("alert");

      function handleQueue() {
        if (isPlaying || alertQueue.length == 0) return;
        const alert = alertQueue.shift();
        if (alert.viewers !== undefined) raidAlert(alert);
        else subAlert(alert);
      }
      function raidAlert(raidInfo) {
        isPlaying = true;
        isPlaying = false;
      }
      function subAlert(subInfo) {
        isPlaying = true;
        let tier = "";

        switch (subInfo.plan) {
          case "Prime":
            tier = "with Prime";
            break;
          case "1000":
            tier = "at Tier 1";
            break;
          case "2000":
            tier = "at Tier 2";
            break;
          case "3000":
            tier = "at Tier 3";
            break;
        }
        if (!subInfo.message) subInfo.message = "";
        else
          subInfo.message = subInfo.message
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");

        alertElement.id = "alert";
        if (!subInfo.gift)
          alertElement.innerHTML = ` <img class="bab" height="150" src="/static/bab.png" /><img class="exp" id="exp0" height="150" /><img class="exp" id="exp1" height="150" /><img class="exp" id="exp2" height="150"  /><span class="text" ><span class="sender">${subInfo.name} </span>just subscribed ${tier} for ${subInfo.months} months </span><br /><span class="message">${subInfo.message}</span> `;
        else
          alertElement.innerHTML = ` <img class="bab" height="150" src="/static/bab.png" /><img class="exp" id="exp0" height="150" /><img class="exp" id="exp1" height="150" /><img class="exp" id="exp2" height="150"  /><br /><span class="text"><span class="sender">${subInfo.gifter} </span>just gifted subscription ${tier} for ${subInfo.months} months to <span class="sender">${subInfo.name}</span></span><br /><span class="message">${subInfo.message}</span>`;

        const imgElement = document.getElementById("image");
        const exp = new Audio("/static/explosions.mp3");
        const usera = getTTSAudio({ voice: "Brian", text: subInfo.name });
        const sub = new Audio("/static/sub.mp3");
        const exp0 = document.getElementById("exp0");
        const exp1 = document.getElementById("exp1");
        const exp2 = document.getElementById("exp2");
        exp0.src = "/static/explosion0.gif";
        setTimeout(() => {
          exp1.src = "/static/explosion1.gif";
        }, 733);
        setTimeout(() => {
          exp2.src = "/static/explosion2.gif";
        }, 1553);

        setTimeout(() => {
          exp0.src = "";
        }, 2550);

        setTimeout(() => {
          exp1.src = "";
        }, 733 + 2550);
        setTimeout(() => {
          exp2.src = "";
        }, 1553 + 2550);

        exp.onended = () => {
          usera.play();
        };
        usera.onended = () => {
          sub.play();
          setTimeout(() => {
            exp0.src = "/static/explosion1.gif";
          }, 2005);
        };
        sub.onended = () => {
          exp0.style.display = "none";
          if (subInfo.message == null) {
            alertElement.style = "opacity: 0%";
            alertElement.innerHTML = "";
            isPlaying = false;
            return;
          }
          const message = getTTSAudio({
            voice: "Brian",
            text: subInfo.message,
          });
          message.onended = () => {
            alertElement.style = "opacity: 0%";
            alertElement.innerHTML = "";
            isPlaying = false;
          };

          message.play();
        };

        exp.play();
        alertElement.style = "opacity: 100%";
      }

      var socket = io("/", { path: "/alerts/" });
      socket.on("alert", (alertInfo) => {
        alertQueue.push(alertInfo);
      });
    </script>
  </body>
</html>
